#!/bin/sh

ROOTFS=/rootfs

if [ -d $ROOTFS ]; then
    # re-run inside chroot
    chroot $ROOTFS /bin/sh /boot/post-install.txt

else
    # already in chroot
    RASPDIR=/root/RASP
    RASPURL=https://github.com/nilx/RASP.git

    # get RASP code
    rm -rf $RASPDIR
    # TODO: use busybox wget+unzip instead, no need to chroot?
    git clone $RASPURL $RASPDIR

    # update on reboot if needed
    cat <<EOF >> /etc/crontab
@reboot root test -f $RASPDIR/update-on-reboot && $RASPDIR/scripts/update >> /var/log/rasp-update.log; rm $RASPDIR/update-on-reboot
EOF
    # mark as needed
    touch $RASPDIR/update-on-reboot
fi
