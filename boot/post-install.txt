#!/bin/sh
set -x

ROOTFS=/rootfs

if [ -d $ROOTFS ]; then

    # red+green heartbeat = post-install setup
    echo heartbeat > /sys/class/leds/led0/trigger
    echo heartbeat > /sys/class/leds/led1/trigger

    # re-run from chroot
    chroot $ROOTFS /bin/sh /boot/post-install.txt

else

    # get RASP code
    rm -rf /root/RASP
    # TODO: use wget+unzip instead
    git clone https://github.com/nilx/RASP.git /root/RASP
    cd /root/RASP/chef

    # run chef recipes
    CHEFOPTS="-z -c client.rb"
    RECIPES=
    RECIPES="${RECIPES}recipe[rasp-base-setup::heartbeat],"
    RECIPES="${RECIPES}recipe[rasp-base-setup::motd],"
    RECIPES="${RECIPES}recipe[rasp-base-setup::packages],"
    RECIPES="${RECIPES}recipe[rasp-base-setup::firmware],"
    RECIPES="${RECIPES}recipe[rasp-base-setup::rng],"

    chef-client $CHEFOPTS -r $RECIPES

fi
